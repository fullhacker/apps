/*
    Author: Ayo Ayco
    Email: ramon.aycojr@gmail.com
    Website: AyoAyco.com
    Blog: FullHacker.com
    Live: games.fullhacker.com/minesweeper
*/

import{DatabaseService}from"./db.service.js";import{TimerService}from"./timer.service.js";import{UserService}from"./user.service.js";import{LoadingService}from"./loading/loading.js";const dbService=new DatabaseService,timerService=new TimerService,loadingService=new LoadingService,db=dbService.store,user=new UserService;let previousLevel;export class LeaderBoardService{constructor(e,t){this.leaders=db.collection(e),this.all=db.collection(t)}updateTimeStampsLeaders(){["beginner","intermediate","expert"].forEach(e=>{const t=this.leaders.doc(e).collection("games");t.get().then(s=>{s.docs.map(e=>({id:e.id,...e.data()})).forEach(s=>{const i=s.time,r=s.browserId;this.all.doc(r).collection("games").get().then(o=>{const n=o.docs.map(e=>({id:e.id,games:{...e.data()}}));console.log(e+"..........."+r),n.forEach(e=>{Object.keys(e.games).filter(t=>"win"===e.games[t].status).forEach(r=>{const o=e.games[r],n=[e.id,r].join(" ").replace(/_/g," "),a={time_stamp:new Date(n),...s};o.time===i&&(console.log("updated",a),t.doc(s.id).set(a))})})})})})})}update(e,t,s){e!==previousLevel&&(loadingService.addLoading(t),previousLevel=e,this.unsubscribe&&this.unsubscribe(),this.lastPlace=Number.MAX_SAFE_INTEGER,this.topList=this.leaders.doc(e).collection("games").orderBy("time").limit(10),this.unsubscribe=this.setListener(this.topList,t,s))}renderList(e,t,s){if(!e)return;e.innerHTML="";const i=document.createElement("h3");i.innerText=t,i.style.borderBottom="1px solid #c0c0c0",i.style.paddingBottom="10px",e.style.maxWidth="270px",e.style.margin="0 auto";const r=document.createElement("ol");if(r.innerHTML="",r.style.listStyle="none",r.style.textAlign="left",r.style.marginLeft="-40px",r.style.marginTop="-15px",s&&s.length){let t=1;s.forEach(e=>{if(e){const s=timerService.pretty(e.data().time),i=e.data().name||"Anonymous",o=document.createElement("li");o.innerHTML=`#${t++}: <em>${i}</em> ${s}`,r.append(o)}}),s.length>=10&&(this.lastPlace=s[9].data().time),e.append(i,r)}else{const t=document.createElement("em");t.innerText="Be the first to the top!",e.append(i,t)}}setListener(e,t,s){return e.onSnapshot(e=>this.renderList(t,s,e.docs))}send(e,t){const s=(new Date).toDateString().replace(/\s/g,"_"),i=(new Date).toTimeString().replace(/\s/g,"_"),r={};if(e={time_stamp:new Date,...e},r[i]=e,this.all.doc(user.browserId).collection("games").doc(s).set(r,{merge:!0}),"win"===e.status&&e[t]<this.lastPlace){let t=window.prompt("Top performance! Enter your name:");t||(t="Anonymous");const s={name:t,browserId:user.browserId,...e};this.leaders.doc(e.level).collection("games").add(s)}}};