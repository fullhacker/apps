/*
    Author: Ayo Ayco
    Email: ramon.aycojr@gmail.com
    Website: AyoAyco.com
    Blog: FullHacker.com
    Live: games.fullhacker.com/minesweeper
*/

import{DatabaseService}from"./db.service.js";import{TimerService}from"./timer.service.js";import{UserService}from"./user.service.js";const dbService=new DatabaseService,timerService=new TimerService,db=dbService.store,user=new UserService;let previousLevel;export class LeaderBoardService{constructor(e,t){this.leaders=db.collection(e),this.all=db.collection(t)}updateTimeStampsLeaders(){["beginner","intermediate","expert"].forEach(e=>{const t=this.leaders.doc(e).collection("games");t.get().then(s=>{s.docs.map(e=>({id:e.id,...e.data()})).forEach(s=>{const r=s.time,i=s.browserId;this.all.doc(i).collection("games").get().then(o=>{const n=o.docs.map(e=>({id:e.id,games:{...e.data()}}));console.log(e+"..........."+i),n.forEach(e=>{Object.keys(e.games).filter(t=>"win"===e.games[t].status).forEach(i=>{const o=e.games[i],n=[e.id,i].join(" ").replace(/_/g," "),c={time_stamp:new Date(n),...s};o.time===r&&(console.log("updated",c),t.doc(s.id).set(c))})})})})})})}update(e,t,s){e!==previousLevel&&(previousLevel=e,this.unsubscribe&&this.unsubscribe(),this.lastPlace=Number.MAX_SAFE_INTEGER,this.topList=this.leaders.doc(e).collection("games").orderBy("time").limit(10),this.unsubscribe=this.setListener(this.topList,t,s))}setListener(e,t,s){if(!t)return;t.innerHTML="";const r=document.createElement("h3");r.innerText=s,r.style.borderBottom="1px solid #c0c0c0",r.style.paddingBottom="10px";const i=document.createElement("ol");return t.style.maxWidth="270px",t.style.margin="0 auto",e.onSnapshot(e=>{i.innerHTML="",i.style.listStyle="none",i.style.textAlign="left",i.style.marginLeft="-40px",i.style.marginTop="-15px";const s=e.docs;if(s&&s.length){let o=1;s.forEach(e=>{if(e){const t=timerService.pretty(e.data().time),s=e.data().name||"Anonymous",r=document.createElement("li");r.innerHTML=`#${o++}: <em>${s}</em> ${t}`,i.append(r)}}),e.docs.length>=10&&(this.lastPlace=e.docs[9].data().time),t.append(r,i)}else{const e=document.createElement("em");e.innerText="Be the first to the top!",t.append(r,e)}})}send(e,t){const s=(new Date).toDateString().replace(/\s/g,"_"),r={};if(r[(new Date).toTimeString().replace(/\s/g,"_")]=e,this.all.doc(user.browserId).collection("games").doc(s).set(r,{merge:!0}),"win"===e.status&&e[t]<this.lastPlace){let t=window.prompt("Top performance! Enter your name:");t||(t="Anonymous");const s={name:t,browserId:user.browserId,...e};this.leaders.doc(e.level).collection("games").add(s)}}};
