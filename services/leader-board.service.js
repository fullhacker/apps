/*
    Author: Ayo Ayco
    Email: ramon.aycojr@gmail.com
    Website: AyoAyco.com
    Blog: FullHacker.com
    Live: games.fullhacker.com/minesweeper
*/
import{DatabaseService}from"./db.service.js";import{TimerService}from"./timer.service.js";import{UserService}from"./user.service.js";import{LoadingService}from"./loading/loading.js";const dbService=new DatabaseService,timerService=new TimerService,loadingService=new LoadingService,db=dbService.store,user=new UserService;let previousLevel;export class LeaderBoardService{constructor(e,t){this.leaders=db.collection(e),this.all=db.collection(t)}updateTimeStampsLeaders(){["beginner","intermediate","expert"].forEach(e=>{const t=this.leaders.doc(e).collection("games");t.get().then(i=>{i.docs.map(e=>({id:e.id,...e.data()})).forEach(i=>{const s=i.time,r=i.browserId;this.all.doc(r).collection("games").get().then(o=>{const n=o.docs.map(e=>({id:e.id,games:{...e.data()}}));console.log(e+"..........."+r),n.forEach(e=>{Object.keys(e.games).filter(t=>"win"===e.games[t].status).forEach(r=>{const o=e.games[r],n=[e.id,r].join(" ").replace(/_/g," "),a={time_stamp:new Date(n),...i};o.time===s&&(console.log("updated",a),t.doc(i.id).set(a))})})})})})})}update(e,t,i){e!==previousLevel&&(loadingService.addLoading(t),previousLevel=e,this.unsubscribe&&this.unsubscribe(),this.lastPlace=Number.MAX_SAFE_INTEGER,this.topList=this.leaders.doc(e).collection("games").orderBy("time").limit(10),this.unsubscribe=this.setListener(this.topList,t,i))}renderList(e,t,i){if(!e)return;e.innerHTML="";const s=document.createElement("h3");s.innerText=t,s.style.borderBottom="1px solid #c0c0c0",s.style.paddingBottom="10px",e.style.maxWidth="270px",e.style.margin="0 auto";const r=document.createElement("div");if(r.innerHTML="",r.style.listStyle="none",r.style.textAlign="left",r.style.marginTop="-15px",i&&i.length){let t=1;i.forEach(e=>{if(e){const i=timerService.pretty(e.data().time),s=e.data().name||"Anonymous",o=document.createElement("div");o.style.display="flex";const n=document.createElement("div");n.innerHTML=s,n.setAttribute("title",s),n.style.textOverflow="ellipsis",n.style.whiteSpace="nowrap",n.style.overflow="hidden",n.style.padding="0 5px",n.style.cursor="pointer",n.style.fontWeight="bold",n.style.fontStyle="italic";const a=document.createElement("div");a.innerText=`#${t++}`;const c=document.createElement("div");c.innerText=i,o.append(a,n,c),r.append(o)}}),i.length>=10&&(this.lastPlace=i[9].data().time),e.append(s,r)}else{const t=document.createElement("em");t.innerText="Be the first to the top!",e.append(s,t)}}setListener(e,t,i){return e.onSnapshot(e=>this.renderList(t,i,e.docs))}send(e,t){const i=(new Date).toDateString().replace(/\s/g,"_"),s=(new Date).toTimeString().replace(/\s/g,"_"),r={};if(e={time_stamp:new Date,...e},r[s]=e,this.all.doc(user.browserId).collection("games").doc(i).set(r,{merge:!0}),"win"===e.status&&e[t]<this.lastPlace){let t=window.prompt("Top performance! Enter your name:");t||(t="Anonymous");const i={name:t,browserId:user.browserId,...e};this.leaders.doc(e.level).collection("games").add(i)}}};